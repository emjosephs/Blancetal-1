---
title: "Identifying Selected Genes with Quaint"
author: "Emily Josephs"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd('~/Documents/Blancetal-1//analysis/')

library(ggplot2)
library(reshape2)
library(ggpubr)
library(quaint)
library(tidyr)
```


## Intro 

I'm rerunning the code to identify selected genes with the Quaint package




```{r}

### function for testing all genes
testAllGenes <- function(myTissue){
# Read in mean-centered expression values
df1 <- read.table(paste("../data/Mean_centered_expression/",myTissue,".txt",sep=""))
# Read in tissue specific kinship matrix 
myF <- read.table(paste('../data/Kinship_matrices/F_',myTissue,'.txt',sep=""))

## Get Eigen Values and Vectors 
myE <- eigen(myF)
E_vectors <- myE$vectors
E_values <- myE$values

## Testing for selection on first 5 PCs
myM = 1:5

## Using the last 1/2 of PCs to estimate Va
myL = 6:dim(myF)[1]

## test for selection on each gene
allGeneOutput <- sapply(1:ncol(df1), function(x){
myQpc = calcQpc(myZ = df1[,x], myU = E_vectors, myLambdas = E_values, myL = myL, myM = myM)
return(myQpc)
})

return(allGeneOutput)
}

###run on all genes
alltissues = c('GRoot',"Kern","LMAD26","LMAN26", "L3Tip","GShoot","L3Base","LMAD8","LMAN8")
alltissueresults = lapply(alltissues, testAllGenes)
names(alltissueresults) <- alltissues



##look at sig results
sigresults = lapply(1:length(alltissues), function(i){
# extract the pvalues
pvals = matrix(unlist(alltissueresults[[i]][4,]), ncol=5, byrow=TRUE) #each row corresponds to a gene, columns are to PCs

##look at pvalue distributions
par(mfrow=c(3,2), mar=c(4,4,1,1))
sapply(1:5, function(x){
hist(pvals[,x], border="white", col = "darkgray", main="", breaks = 20, xlab = paste('PC ',x,' ',alltissues[i],sep=""))
})

## test fpr sogmofocamce
pfdr = data.frame(apply(pvals,2, function(x){p.adjust(x, method='fdr')}))

## how many are significant?
numsig <- apply(pfdr, 2, function(x){sum(x<0.1)})
numsig
})

###make a big image of how many sig results we have
sigTable = as.data.frame(matrix(unlist(sigresults), ncol=5, byrow=T))
names(sigTable) = c('PC1','PC2','PC3','PC4','PC5')
sigTable$tissue = alltissues
sigLong = tidyr::gather(sigTable, 'variable','value', -tissue)
sigLong[sigLong == 0] <- NA

pl <- ggplot(data=sigLong,aes(x=variable,y=tissue)) + 
  geom_tile(aes(fill=value),color='black') + scale_fill_gradient(low = 'lightyellow', high = "#CC79A7", guide = FALSE, na.value = "white") + theme_bw() + xlab("\n") + ylab("Tissue") + 
  theme(axis.ticks=element_blank(),panel.border=element_blank(),panel.grid.major = element_blank(), axis.text.y = element_text(size=10,angle=0), axis.title.y = element_text(size=16),axis.title.x  = element_text(size=16),axis.text.x = element_text(angle = 0, hjust = 0.5,size=14)) + geom_text(aes(label=value),colour="grey15",size=3.5)

pl

```

Make some individual gene ploes
```{r}
pop <- read.csv("../data/FlintGarciaTableS1_fixednew.csv")
lmad26_all <- read.table("../data/Mean_centered_expression/LMAD26.txt")
lmad26_all$lines <- row.names(lmad26_all)
pop_dat <- merge(pop, lmad26_all, by.x = "Inbred", by.y = "lines" )

myF <- read.table('../data/Kinship_matrices/F_LMAD26.txt')
myE <- eigen(myF)
E_vectors <- myE$vectors
E_values <- myE$values


##what gene to plot
pvals = matrix(unlist(alltissueresults[['LMAD26']][4,]), ncol=5, byrow=TRUE) #each row corresponds to a gene, columns are to 
pfdr = data.frame(apply(pvals,2, function(x){p.adjust(x, method='fdr')}))
pfdr$index = 1:nrow(pfdr)

##the sig LMAD26 one on PC 1
sigPC1 = dplyr::filter(pfdr, X1 < 0.1)
pop_dat$sel <- lmad26_all[,sigPC1$index]
pop_dat$one <- E_vectors[,1]
lambda <- E_values[1]

##calculate the CIs
generesults = alltissueresults[['LMAD26']][,sigPC1$index]
myVaest = var0(generesults$cml)
myCI = 1.96*sqrt(myVaest*lambda)

##gene name
names(lmad26_all)[sigPC1$index]

lR <- lm(pop_dat$sel ~ pop_dat$one) 
coeff <- lR$coefficients[[2]]

col <- c('#E69F00', '#56B4E9', "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
pl1 <- ggplot(data=pop_dat, aes(x = one, y= sel , color=Subpopulation)) + scale_colour_manual(values = col, labels=c("mixed", "non-stiff stalk", "popcorn", "stiff stalk", "tropical")) + xlab("PC 1") +  ylab("Mean-centered Expression") + theme_bw() + theme(panel.grid.major = element_blank(), text = element_text(size=20), panel.grid.minor = element_blank(), axis.title.y = element_text(size=18), axis.title.x  = element_text(size=18), legend.position = "right", legend.title = element_text(size = 12), legend.text = element_text(size = 20), plot.title = element_text(hjust = 0.5)) + geom_point(size = 3.5) + geom_abline(slope = myCI, linetype = 2, col = '#56B4E9', size=1.2) + geom_abline(slope = coeff, size = 1.5)+  geom_abline(slope = -myCI, linetype = 2, col = '#56B4E9', size=1.2)

pl1


###make a plot for a nonsig gene
mgi= sigPC1$index+27
pop_dat$sel1 <- lmad26_all[,mgi]

##gene name
names(lmad26_all)[mgi]

generesults = alltissueresults[['LMAD26']][,mgi]
myVaest = var0(generesults$cml)
myCI = 1.96*sqrt(myVaest*lambda)


lR <- lm(pop_dat$sel1 ~ pop_dat$one) 
coeff <- lR$coefficients[[2]]

col <- c('#E69F00', '#56B4E9', "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
pl2 <- ggplot(data=pop_dat, aes(x = one, y= sel1 , color=Subpopulation)) + scale_colour_manual(values = col, labels=c("mixed", "non-stiff stalk", "popcorn", "stiff stalk", "tropical")) + xlab("PC 1") +  ylab("Mean-centered Expression") + theme_bw() + ylim(-100,100) + theme(panel.grid.major = element_blank(), text = element_text(size=20), panel.grid.minor = element_blank(), axis.title.y = element_text(size=18), axis.title.x  = element_text(size=18), legend.position = "right", legend.title = element_text(size = 12), legend.text = element_text(size = 20), plot.title = element_text(hjust = 0.5)) + geom_point(size = 3.5) + geom_abline(slope = myCI, linetype = 2, col = '#56B4E9', size=1.2) + geom_abline(slope = coeff, size = 1.5)+  geom_abline(slope = -myCI, linetype = 2, col = '#56B4E9', size=1.2)

pl2


###make a plot for PC5
sigPC5 = dplyr::filter(pfdr, X5 < 0.1)
sigPC5$gene = names(lmad26_all)[sigPC5$index]
mgi = sigPC5$index[6]

pop_dat$sel5 <- lmad26_all[,mgi]
pop_dat$one <- E_vectors[,5]
lambda <- E_values[5]

##calculate the CIs
generesults = alltissueresults[['LMAD26']][,mgi]
myVaest = var0(generesults$cml)
myCI = 1.96*sqrt(myVaest*lambda)

##gene name
names(lmad26_all)[sigPC1$index]

lR <- lm(pop_dat$sel5 ~ pop_dat$one) 
coeff <- lR$coefficients[[2]]

pl3 <- ggplot(data=pop_dat, aes(x = one, y= sel5 , color=Subpopulation)) + scale_colour_manual(values = col, labels=c("mixed", "non-stiff stalk", "popcorn", "stiff stalk", "tropical")) + xlab("PC 1") +  ylab("Mean-centered Expression") + theme_bw() + theme(panel.grid.major = element_blank(), text = element_text(size=20), panel.grid.minor = element_blank(), axis.title.y = element_text(size=18), axis.title.x  = element_text(size=18), legend.position = "right", legend.title = element_text(size = 12), legend.text = element_text(size = 20), plot.title = element_text(hjust = 0.5)) + geom_point(size = 3.5) + geom_abline(slope = myCI, linetype = 2, col = '#56B4E9', size=1.2) + geom_abline(slope = coeff, size = 1.5)+  geom_abline(slope = -myCI, linetype = 2, col = '#56B4E9', size=1.2)

pl3

```

I think the main difference is the PCs that I'm using to estimate Va are different from Jennifer's (she uses 11:20). Let's check.

```{r}

### function for testing all genes
testAllGenes1120 <- function(myTissue){
# Read in mean-centered expression values
df1 <- read.table(paste("../data/Mean_centered_expression/",myTissue,".txt",sep=""))
# Read in tissue specific kinship matrix 
myF <- read.table(paste('../data/Kinship_matrices/F_',myTissue,'.txt',sep=""))

## Get Eigen Values and Vectors 
myE <- eigen(myF)
E_vectors <- myE$vectors
E_values <- myE$values

## Testing for selection on first 5 PCs
myM = 1:5

## Using the last 1/2 of PCs to estimate Va
myL = 11:20

## test for selection on each gene
allGeneOutput <- sapply(1:ncol(df1), function(x){
myQpc = calcQpc(myZ = df1[,x], myU = E_vectors, myLambdas = E_values, myL = myL, myM = myM)
return(myQpc)
})

return(allGeneOutput)
}



alltissueresults1120 = lapply(alltissues, testAllGenes1120)
names(alltissueresults1120) <- alltissues



##look at sig results
sigresults1120 = lapply(1:length(alltissues), function(i){
# extract the pvalues
pvals = matrix(unlist(alltissueresults1120[[i]][4,]), ncol=5, byrow=TRUE) #each row corresponds to a gene, columns are to PCs

##look at pvalue distributions
par(mfrow=c(3,2), mar=c(4,4,1,1))
sapply(1:5, function(x){
hist(pvals[,x], border="white", col = "darkgray", main="", breaks = 20, xlab = paste('PC ',x,' ',alltissues[i],sep=""))
})

## test fpr sogmofocamce
pfdr = data.frame(apply(pvals,2, function(x){p.adjust(x, method='fdr')}))

## how many are significant?
numsig <- apply(pfdr, 2, function(x){sum(x<0.1)})
numsig
})

###make a big image of how many sig results we have
sigTable1120 = as.data.frame(matrix(unlist(sigresults1120), ncol=5, byrow=T))
names(sigTable1120) = c('PC1','PC2','PC3','PC4','PC5')
sigTable1120$tissue = alltissues
sigLong1120 = tidyr::gather(sigTable1120, 'variable','value', -tissue)


pl <- ggplot(data=sigLong1120,aes(x=variable,y=tissue)) + 
  geom_tile(aes(fill=value),color='black') + scale_fill_gradient(low = 'lightyellow', high = "#CC79A7", guide = FALSE, na.value = "white") + theme_bw() + xlab("\n") + ylab("Tissue") + 
  theme(axis.ticks=element_blank(),panel.border=element_blank(),panel.grid.major = element_blank(), axis.text.y = element_text(size=10,angle=0), axis.title.y = element_text(size=16),axis.title.x  = element_text(size=16),axis.text.x = element_text(angle = 0, hjust = 0.5,size=14)) + geom_text(aes(label=value),colour="grey15",size=3.5)

pl
```

Make a PC plot
```{r}
pop_dat$PC1 = E_vectors[,1]
pop_dat$PC2 = E_vectors[,2]
pop_dat$PC3 = E_vectors[,3]
pop_dat$PC4 = E_vectors[,4]


col <- c('#E69F00', '#56B4E9', "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
plpc <- ggplot(data=pop_dat, aes(x = PC1, y= PC2 , color=Subpopulation)) + scale_colour_manual(values = col, labels=c("mixed", "non-stiff stalk", "popcorn", "stiff stalk", "tropical")) + xlab("PC 1") +  ylab("PC 2") + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size=17), axis.title.x  = element_text(size=17), legend.position = "bottom",  legend.text = element_text(size = 14), plot.title = element_text(), axis.text.y = element_text(size=10), axis.text.x = element_text(size=10)) + geom_point(size = 2 )
plpc


col <- c('#E69F00', '#56B4E9', "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
plpc <- ggplot(data=pop_dat, aes(x = PC3, y= PC4 , color=Subpopulation)) + scale_colour_manual(values = col, labels=c("mixed", "non-stiff stalk", "popcorn", "stiff stalk", "tropical")) + xlab("PC 3") +  ylab("PC 4") + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size=17), axis.title.x  = element_text(size=17), legend.position = "bottom",  legend.text = element_text(size = 14), plot.title = element_text(), axis.text.y = element_text(size=10), axis.text.x = element_text(size=10)) + geom_point(size = 2 )
plpc

```